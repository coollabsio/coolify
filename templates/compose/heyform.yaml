# documentation: https://docs.heyform.net/open-source/self-hosting
# slogan: Allows anyone to create engaging conversational forms for surveys, questionnaires, quizzes, and polls. No coding skills required.
# tags: form, builder, forms, survey, quiz, open source, self-hosted, docker
# logo: svgs/heyform.svg
# port: 8000

services:
  heyform:
    image: heyform/community-edition:latest
    volumes:
      - heyform-assets:/app/static/upload
    depends_on:
      mongo:
        condition: service_healthy
      keydb:
        condition: service_healthy
    environment:
         - SERVICE_FQDN_HEYFORM_8000
         - APP_HOMEPAGE_URL=${APP_HOMEPAGE_URL}
         - SESSION_KEY=${SESSION_KEY}
         - FORM_ENCRYPTION_KEY=${FORM_ENCRYPTION_KEY}
         - MONGO_URI=${MONGO_URI}
         - REDIS_HOST=${REDIS_HOST}
         - REDIS_PORT=${REDIS_PORT}
         - REDIS_PASSWORD=${REDIS_PASSWORD}
         - APP_LISTEN_PORT=${APP_LISTEN_PORT}
         - APP_LISTEN_HOSTNAME=${APP_LISTEN_HOSTNAME}
         - APP_DISABLE_REGISTRATION=${APP_DISABLE_REGISTRATION}
         - COOKIE_MAX_AGE=${COOKIE_MAX_AGE}
         - SESSION_MAX_AGE=${SESSION_MAX_AGE}
         - UPLOAD_FILE_TYPES=${UPLOAD_FILE_TYPES}
         - UPLOAD_FILE_SIZE=${UPLOAD_FILE_SIZE}
         - BCRYPT_SALT=${BCRYPT_SALT}
         - MONGO_USER=${MONGO_USER}
         - MONGO_PASSWORD=${MONGO_PASSWORD}
         - MONGO_SSL_CA_PATH=${MONGO_SSL_CA_PATH}
         - REDIS_DB=${REDIS_DB}
         - VERIFY_USER_EMAIL=${VERIFY_USER_EMAIL}
         - SMTP_FROM=${SMTP_FROM}
         - SMTP_HOST=${SMTP_HOST}
         - SMTP_PORT=${SMTP_PORT}
         - SMTP_USER=${SMTP_USER}
         - SMTP_SECURE=${SMTP_SECURE}
         - SMTP_IGNORE_CERT=${SMTP_IGNORE_CERT}
         - SMTP_PASSWORD=${SMTP_PASSWORD}
         - GOOGLE_RECAPTCHA_KEY=${GOOGLE_RECAPTCHA_KEY}
         - GOOGLE_RECAPTCHA_SECRET=${GOOGLE_RECAPTCHA_SECRET}
         - GEETEST4_CAPTCHA_ID=${GEETEST4_CAPTCHA_ID}
         - GEETEST4_CAPTCHA_KEY=${GEETEST4_CAPTCHA_KEY}
         - AKISMET_KEY=${AKISMET_KEY}
         - APPLE_LOGIN_TEAM_ID=${APPLE_LOGIN_TEAM_ID}
         - APPLE_LOGIN_WEB_CLIENT_ID=${APPLE_LOGIN_WEB_CLIENT_ID}
         - APPLE_LOGIN_KEY_ID=${APPLE_LOGIN_KEY_ID}
         - APPLE_LOGIN_PRIVATE_KEY_PATH=${APPLE_LOGIN_PRIVATE_KEY_PATH}
         - GOOGLE_LOGIN_CLIENT_ID=${GOOGLE_LOGIN_CLIENT_ID}
         - GOOGLE_LOGIN_CLIENT_SECRET=${GOOGLE_LOGIN_CLIENT_SECRET}
         - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
         - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
         - STRIPE_CONNECT_CLIENT_ID=${STRIPE_CONNECT_CLIENT_ID}
         - STRIPE_WEBHOOK_SECRET_KEY=${STRIPE_WEBHOOK_SECRET_KEY}
         - BULL_JOB_ATTEMPTS=${BULL_JOB_ATTEMPTS}
         - BULL_JOB_TIMEOUT=${BULL_JOB_TIMEOUT}
         - BULL_JOB_BACKOFF_DELAY=${BULL_JOB_BACKOFF_DELAY}
         - BULL_JOB_BACKOFF_TYPE=${BULL_JOB_BACKOFF_TYPE}
         - INVITE_CODE_EXPIRE_DAYS=${INVITE_CODE_EXPIRE_DAYS}
         - FORM_REPORT_RATE=${FORM_REPORT_RATE}
         - VERIFICATION_CODE_EXPIRE=${VERIFICATION_CODE_EXPIRE}
         - VERIFICATION_CODE_LIMIT=${VERIFICATION_CODE_LIMIT}
         - ACCOUNT_DELETION_SCHEDULE_INTERVAL=${ACCOUNT_DELETION_SCHEDULE_INTERVAL}
         - UNSPLASH_CLIENT_ID=${UNSPLASH_CLIENT_ID}
         - OPENAI_BASE_URL=${OPENAI_BASE_URL}
         - OPENAI_API_KEY=${OPENAI_API_KEY}
         - OPENAI_GPT_MODEL=${OPENAI_GPT_MODEL}

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8000 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 3

  mongo:
    image: percona/percona-server-mongodb:latest
    volumes:
      - heyform-mongo-data:/data/db
    healthcheck:
      test: ["CMD-SHELL", "echo 'ok' > /dev/null 2>&1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s

  keydb:
    image: eqalpha/keydb:latest
    command: keydb-server --appendonly yes
    environment:
      - KEYDB_PASSWORD=${SERVICE_PASSWORD_KEYDB}
    volumes:
      - heyform-keydb-data:/data
    healthcheck:
      test: ["CMD-SHELL", "keydb-cli", "--pass", "${SERVICE_PASSWORD_KEYDB}", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
